# Chore: Complete HCL Generation Parity with cs-runner

## Chore Description
The current HCL generation in the Go dispatch mode is minimal and missing critical fields required for nomadpack deployments. The cs-runner generates comprehensive HCL with two files (waypoint.hcl and vars.hcl) containing all deployment configuration including Nomad address/token, registry settings, resource constraints, networking, Vault integration, Consul configuration, and more. The Go implementation only generates basic build/deploy stanzas, causing "pack name is required" errors and other deployment failures.

This chore implements complete parity with cs-runner's HCL generation to support full nomadpack deployments with all configuration fields.

## Relevant Files

**Existing Files to Update:**

- `internal/hclgen/types.go` - Add all missing deployment parameter fields to match cs-runner's DeploymentJobOptions type
- `internal/hclgen/generator.go` - Complete HCL template to include nomadpack configuration, registry settings, and variable generation
- `internal/dispatch/types.go` - Add all missing fields to DeployRepositoryParams and DeployImageParams to capture full payload data
- `internal/dispatch/handlers.go` - Pass complete deployment parameters to HCL generator including nomad/vault/registry config
- `internal/dispatch/params.go` - Update parameter parsing to handle nested registry, consul, jobConfig objects

**Reference Files (cs-runner):**

- `/Users/oumnyabenhassou/Code/runner/cs-runner/src/lib/hcl/types.ts` - Complete type definitions for all deployment options
- `/Users/oumnyabenhassou/Code/runner/cs-runner/src/lib/hcl/hcl.ts` - Waypoint file generation with runner block and variables
- `/Users/oumnyabenhassou/Code/runner/cs-runner/src/lib/hcl/deploy.ts` - Deploy stanza generation with nomad-pack configuration and vars.hcl generation
- `/Users/oumnyabenhassou/Code/runner/cs-runner/src/lib/hcl/build.ts` - Build stanza generation with builder-specific configuration
- `/Users/oumnyabenhassou/Code/runner/cs-runner/src/lib/hcl/registry.ts` - Registry parameter generation

**Files to Reference:**

- `builtin/nomadpack/plugin.go:22-62` - PlatformConfig showing all required nomadpack fields
- `examples/nixpacks-example.hcl` - Example HCL structure showing proper syntax

### New Files

- `internal/hclgen/generator_test.go` - Update tests to validate complete HCL generation with all fields

## Step by Step Tasks

### 1. Analyze cs-runner HCL Generation Complete Structure

- Read `/Users/oumnyabenhassou/Code/runner/cs-runner/src/lib/hcl/types.ts` to document all DeploymentJobOptions fields
- Read `/Users/oumnyabenhassou/Code/runner/cs-runner/src/lib/hcl/deploy.ts:242-267` to understand deploy stanza structure
- Read `/Users/oumnyabenhassou/Code/runner/cs-runner/src/lib/hcl/deploy.ts:268-350` to understand vars.hcl generation
- Read `/Users/oumnyabenhassou/Code/runner/cs-runner/src/lib/hcl/registry.ts` to understand registry parameter mapping
- Read `/Users/oumnyabenhassou/Code/runner/cs-runner/src/lib/hcl/build.ts` to understand builder configurations
- Document the complete structure of both waypoint.hcl and vars.hcl files generated by cs-runner

### 2. Extend DeploymentParams Type with All Missing Fields

- Edit `internal/hclgen/types.go`
- Add `NomadAddress string` field for Nomad API endpoint
- Add `NomadToken string` field for Nomad authentication
- Add `VaultAddress string` field for Vault API endpoint
- Add `RoleId string` and `SecretId string` fields for Vault AppRole auth
- Add `SecretsPath string` field for Vault secrets location
- Add `RegistryConfig` struct with fields: `Pack`, `RegistryName`, `RegistrySource`, `RegistryRef`, `RegistryTarget`, `RegistryToken`
- Add resource fields: `CPU int`, `RAM int`, `GPU int`
- Add `Networks []NetworkPort` slice for port configuration
- Add `ConsulConfig` struct with fields: `ServiceName`, `Tags []string`, `LinkedServices`
- Add `NodePool string` for Nomad node pool targeting
- Add `RestartMode string` and `RestartAttempts int` for restart policy
- Add `CSIVolumes []CSIVolume` for persistent storage
- Add `JobConfig` struct with fields: `Type string`, `ProhibitOverlap bool`, `Cron string`, `MetaRequired []string`
- Add `OwnerID string`, `ProjectID string`, `ServiceID string`, `TeamID string` for multi-tenancy
- Add `DeploymentCount int` to track deployment iterations
- Add `Command string`, `Entrypoint []string`, `DockerUser string` for container configuration

### 3. Update Dispatch Types to Capture Complete Payload

- Edit `internal/dispatch/types.go`
- Add `RegistrySettings` struct matching cs-runner's registry type with all pack fields
- Add `ConsulSettings` struct with ServiceName, Tags, LinkedServices
- Add `NetworkPort` struct with PortNumber, PortType, Public, Domain, CustomDomain, HealthCheck
- Add `CSIVolumeSettings` struct with ID and MountPaths
- Add `JobTypeConfig` struct with Type, Cron, ProhibitOverlap, MetaRequired fields
- Update `DeployRepositoryParams` to include: NomadAddress, NomadToken, VaultAddress, RoleId, SecretId, SecretsPath, Registry, Networks, CPU, RAM, GPU, Consul, CSIVolume, NodePool, RestartMode, JobConfig, OwnerID, ProjectID, Command, Entrypoint, DockerUser
- Update `DeployImageParams` to include same deployment configuration fields
- Ensure all JSON struct tags match cs-runner field names exactly (e.g., `nomadAddress`, `vaultAddress`, etc.)

### 4. Implement Complete HCL Template Generation

- Edit `internal/hclgen/generator.go`
- Update `hclTemplate` constant to include:
  - `runner { enabled = true }` block (matching cs-runner)
  - Complete `deploy` block with nomad-pack configuration:
    - `deployment_name` from JobID
    - `pack` from RegistryConfig.Pack
    - `registry_name` from RegistryConfig.RegistryName
    - `registry_source` from RegistryConfig.RegistrySource
    - `registry_ref` from RegistryConfig.RegistryRef
    - `registry_target` from RegistryConfig.RegistryTarget
    - `registry_token` from RegistryConfig.RegistryToken (if provided)
    - `nomad_addr` from NomadAddress
    - `nomad_token` from NomadToken
    - `variable_files = ["vars.hcl"]` reference
  - Add variable blocks for username, password, REGISTRY_TOKEN (matching cs-runner structure)
- Create `generateVarsFile()` function to generate vars.hcl content with:
  - Image name and tag variables
  - Resource variables (cpu, memory, gpu)
  - Replica count
  - Restart mode and attempts
  - Network port configurations
  - Consul service configuration
  - Vault secrets path
  - Node pool specification
  - CSI volume mounts
  - Job type configuration
  - Owner/project/service/team IDs
  - Any custom command or entrypoint
- Update `WriteConfigFile()` to write both cloudstation.hcl (main) and vars.hcl (variables)
- Add `WriteVarsFile()` function to write vars.hcl alongside cloudstation.hcl
- Add logic to handle conditional fields (only include if provided in params)

### 5. Update Dispatch Handlers to Pass Complete Configuration

- Edit `internal/dispatch/handlers.go`
- In `HandleDeployRepository`, update hclParams construction to include:
  - NomadAddress: params.NomadAddress
  - NomadToken: params.NomadToken
  - VaultAddress: params.VaultAddress
  - RoleId: params.RoleId
  - SecretId: params.SecretId
  - SecretsPath: params.SecretsPath
  - RegistryConfig: map params.Registry fields to RegistryConfig struct
  - CPU: params.CPU, RAM: params.RAM, GPU: params.GPU
  - Networks: params.Networks
  - ConsulConfig: map params.Consul to ConsulConfig struct
  - NodePool: params.NodePool
  - RestartMode: params.RestartMode
  - CSIVolumes: params.CSIVolume
  - JobConfig: params.JobConfig
  - OwnerID: params.OwnerID, ProjectID: params.ProjectID, ServiceID: params.ServiceID, TeamID: params.TeamID
  - DeploymentCount: params.DeploymentCount
  - Command: params.Command, Entrypoint: params.Entrypoint, DockerUser: params.DockerUser
- Similarly update `HandleDeployImage` with same complete configuration
- Update both handlers to call WriteVarsFile() after WriteConfigFile()

### 6. Handle Build Hook for First Deployment

- Edit `internal/hclgen/generator.go`
- Add hook generation logic in deploy stanza when DeploymentCount == 0:
  ```hcl
  hook {
    when = "before"
    command = ["/bin/sh", "-c", "chmod +x /../vars.sh && /../vars.sh "]
  }
  ```
- This matches cs-runner behavior for initial deployments

### 7. Update Parameter Validation

- Edit `internal/dispatch/params.go`
- Add validation for required nomadpack fields when deploy != "noop":
  - Validate NomadAddress is not empty
  - Validate NomadToken is not empty
  - Validate Registry.Pack is not empty
  - Validate Registry.RegistryName is not empty
- Keep validation lenient for optional fields (networks, consul, etc.)

### 8. Add Comprehensive Tests

- Edit `internal/hclgen/generator_test.go`
- Add test `TestGenerateConfig_CompleteNomadPack` with all fields populated
- Verify generated HCL includes:
  - Correct nomad-pack deploy block with all parameters
  - Registry configuration
  - Variable references
- Add test `TestGenerateVarsFile_AllFields` to validate vars.hcl generation
- Add test `TestGenerateConfig_FirstDeploymentHook` to verify hook is added when DeploymentCount == 0
- Add test `TestGenerateConfig_SubsequentDeploymentNoHook` to verify no hook when DeploymentCount > 0

### 9. Normalize Builder Names

- Edit `internal/hclgen/generator.go`
- Add normalization for builder types: `"docker"` → `"csdocker"`, `""` → `"nixpacks"`
- Match cs-runner's builder name mapping

### 10. Test with Real Payload

- Run `./test-real.sh` to test with actual production payload
- Verify HCL is generated with all nomadpack configuration
- Verify vars.hcl is created with deployment variables
- Check that build completes successfully
- Verify nomadpack deployment executes (or fails with proper Nomad connectivity errors, not config errors)
- Inspect generated cloudstation.hcl and vars.hcl files match cs-runner output structure

### 11. Run All Validation Commands

- Execute all commands from Validation Commands section below
- Fix any test failures or build errors
- Ensure 100% backward compatibility with existing tests

## Validation Commands

Execute every command to validate the chore is complete with zero regressions.

```bash
# Verify Go modules are clean
cd /Users/oumnyabenhassou/Code/runner/cloudstation-orchestrator
go mod verify
go mod tidy

# Build the binary
make clean
make build
ls -lh bin/cs  # Should be ~11-15MB

# Run all unit tests
go test ./internal/hclgen/... -v -cover  # Should show >80% coverage
go test ./internal/dispatch/... -v -cover
go test ./pkg/git/... -v -cover
go test ./pkg/nats/... -v -cover

# Run tests with race detection
go test ./... -race

# Run all tests with coverage
go test ./... -cover -coverprofile=coverage.out
go tool cover -func=coverage.out | grep total  # Should show overall coverage

# Verify HCL generation with debug test
go test -run TestGenerateConfig_CompleteNomadPack ./internal/hclgen/... -v

# Test with real payload
/Users/oumnyabenhassou/Code/runner/cloudstation-orchestrator/test-real.sh

# Verify generated files exist and are valid
# (This will be visible in test-real.sh output showing preserved work directory)

# Code quality checks
go fmt ./...
go vet ./...

# Verify dispatch command still works
./bin/cs dispatch --help
./bin/cs --version

# Test base64 parameter handling
go test -run TestDebugGeneration ./internal/hclgen/... -v
```

## Notes

### Key Differences Between cs-runner and Current Implementation

1. **Two-File System**: cs-runner generates `waypoint.hcl` (structure) and `vars.hcl` (variables), we currently only generate one file
2. **Complete nomad-pack Config**: cs-runner passes pack name, registry details, nomad address/token - we're missing all of this
3. **Variable File Reference**: Deploy stanza must reference `variable_files = ["vars.hcl"]`
4. **Runner Block**: cs-runner includes `runner { enabled = true }` - we're missing this
5. **Comprehensive Variables**: vars.hcl contains 20+ variables for resources, networking, vault, consul, etc.

### Registry Configuration Mapping

From cs-runner payload:
```json
"registry": {
  "pack": "cloud_service",
  "registryName": "cloudstation-packs",
  "registryRef": "main",
  "registrySource": "https://github.com/thecloudstation/cloudstation-packs",
  "registryTarget": "cloud_service",
  "registryToken": "var.REGISTRY_TOKEN"
}
```

Maps to nomadpack config:
```hcl
pack = "cloud_service"
registry_name = "cloudstation-packs"
registry_ref = "main"
registry_source = "https://github.com/thecloudstation/cloudstation-packs"
registry_target = "cloud_service"
registry_token = var.REGISTRY_TOKEN
```

### Critical Fields Often Missing in Minimal Tests

- Networks array (port configurations)
- Consul service discovery settings
- Vault secrets paths
- CSI volumes for persistence
- Job type configuration (service vs batch)
- Resource constraints (CPU/RAM/GPU)
- Multi-tenancy IDs (owner, project, team)

### Backward Compatibility

- Ensure existing `deploy: "noop"` deployments continue working
- Keep build-only execution functional
- Maintain base64 parameter decoding
- Support empty/missing optional fields with sensible defaults
